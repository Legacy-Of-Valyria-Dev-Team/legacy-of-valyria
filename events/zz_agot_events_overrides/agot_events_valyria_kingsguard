agot_kingsguard.1010 = { # Lord Commander Death / Removal
	type = character_event
	title = agot_kingsguard.1010.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:dead_kingsguard }
				desc = agot_kingsguard.1010.desc.intro
			}
			desc = agot_kingsguard.1010.fallback.desc.intro
		}
		first_valid = {
			triggered_desc = {
				trigger = { exists = scope:kingsguard_successor }
				desc = agot_kingsguard.1010.desc.end
			}
			desc = agot_kingsguard.1010.fallback.desc.end
		}
	}
	theme = court
	override_background = {
		trigger = { exists = scope:dead_kingsguard }
		reference = temple
	}
	left_portrait = {
		character = scope:king
		triggered_animation = {
			trigger = { exists = scope:dead_kingsguard }
			animation = sadness
		}
		animation = personality_callous
	}
	right_portrait = {
		character = scope:kingsguard_successor
		animation = personality_callous
	}
	lower_center_portrait = {
		character = scope:removed_kg # The Lord Commander
	}
	immediate = {
		if = {
			limit = { exists = scope:dead_kingsguard }
			play_music_cue = mx_cue_death
		}
		add_character_flag = choosing_lord_commander
		root = {
			save_scope_as = king
		}
		if = {
			limit = {
				exists = cp:kingsguard_1
			}
			cp:kingsguard_1 = {
				save_scope_as = kingsguard_1
				add_to_list = kingsguard_successor
			}
		}
		if = {
			limit = {
				exists = cp:kingsguard_2
			}
			cp:kingsguard_2 = {
				save_scope_as = kingsguard_2
				add_to_list = kingsguard_successor
			}
		}
		if = {
			limit = {
				exists = cp:kingsguard_3
			}
			cp:kingsguard_3 = {
				save_scope_as = kingsguard_3
				add_to_list = kingsguard_successor
			}
		}
		if = {
			limit = {
				exists = cp:kingsguard_4
			}
			cp:kingsguard_4 = {
				save_scope_as = kingsguard_4
				add_to_list = kingsguard_successor
			}
		}
		if = {
			limit = {
				exists = cp:kingsguard_5
			}
			cp:kingsguard_5 = {
				save_scope_as = kingsguard_5
				add_to_list = kingsguard_successor
			}
		}
		if = {
			limit = {
				exists = cp:kingsguard_6
			}
			cp:kingsguard_6 = {
				save_scope_as = kingsguard_6
				add_to_list = kingsguard_successor
			}
		}
		ordered_in_list = {
			list = kingsguard_successor
			limit = {
				is_alive = yes
			}
			order_by = prowess
			save_scope_as = kingsguard_successor
		}
		hidden_effect = {
			title:d_dummy_kingsguard = {
				copy_title_history = title:d_kingsguard
			}
			title:d_dummy_kingsguard2 = {
				copy_title_history = title:d_draconicguard
			}
			# destroy_title = title:d_kingsguard
			# create_title_and_vassal_change = {
			# 	type = granted
			# 	save_scope_as = change
			# }
			# title:d_kingsguard = {
			# 	change_title_holder = {
			# 		holder = root
			# 		change = scope:change
			# 	}
			# }
			# resolve_title_and_vassal_change = scope:change
		}
	}
	option = {
		#Successor
		name = agot_kingsguard.1010.a
		trigger = {
			#Add an opinion boost here
			exists = scope:kingsguard_successor
			scope:kingsguard_successor = { is_alive = yes }
		}
		agot_assign_lord_commander_effect = {
			COMMANDER = scope:kingsguard_successor
			KING = scope:king
		}
		scope:kingsguard_successor = {
			add_opinion = {
				target = ROOT
				modifier = grateful_opinion
				opinion = 20
			}
		}
		remove_character_flag = choosing_lord_commander
	}
	option = {
		name = agot_kingsguard.1010.b
		trigger = {
			exists = scope:kingsguard_1
			NOT = {
				scope:kingsguard_1 = scope:kingsguard_successor
			}
			scope:kingsguard_1 = { is_alive = yes }
		}
		agot_assign_lord_commander_effect = {
			COMMANDER = scope:kingsguard_1
			KING = scope:king
		}
		scope:kingsguard_1 = {
			add_opinion = {
				target = ROOT
				modifier = grateful_opinion
				opinion = 20
			}
		}
		remove_character_flag = choosing_lord_commander
	}
	option = {
		name = agot_kingsguard.1010.c
		trigger = {
			exists = scope:kingsguard_2
			NOT = {
				scope:kingsguard_2 = scope:kingsguard_successor
			}
			scope:kingsguard_2 = { is_alive = yes }
		}
		agot_assign_lord_commander_effect = {
			COMMANDER = scope:kingsguard_2
			KING = scope:king
		}
		scope:kingsguard_2 = {
			add_opinion = {
				target = ROOT
				modifier = grateful_opinion
				opinion = 20
			}
		}
		remove_character_flag = choosing_lord_commander
	}
	option = {
		name = agot_kingsguard.1010.d
		trigger = {
			exists = scope:kingsguard_3
			NOT = {
				scope:kingsguard_3 = scope:kingsguard_successor
			}
			scope:kingsguard_3 = { is_alive = yes }
		}
		agot_assign_lord_commander_effect = {
			COMMANDER = scope:kingsguard_3
			KING = scope:king
		}
		scope:kingsguard_3 = {
			add_opinion = {
				target = ROOT
				modifier = grateful_opinion
				opinion = 20
			}
		}
		remove_character_flag = choosing_lord_commander
	}
	option = {
		#Switch
		name = agot_kingsguard.1010.e
		trigger = {
			OR = {
				exists = scope:kingsguard_4
				exists = scope:kingsguard_5
				exists = scope:kingsguard_6
			}
		}
		trigger_event = agot_kingsguard.1011
		custom_tooltip = kingsguard_other_selections_available_tt
	}
	option = {
		name = agot_kingsguard.1010.f
		trigger = {
			NOR = {
				scope:kingsguard_1 ?= { is_alive = yes }
				scope:kingsguard_2 ?= { is_alive = yes }
				scope:kingsguard_3 ?= { is_alive = yes }
				scope:kingsguard_4 ?= { is_alive = yes }
				scope:kingsguard_5 ?= { is_alive = yes }
				scope:kingsguard_6 ?= { is_alive = yes }
			}
		}
		remove_character_flag = choosing_lord_commander
		ai_chance = {
			base = 0
		}
	}
}

agot_kingsguard.9004 = {
	# Remove KG variables to prevent them rising from the grave if title is recreated
	hidden = yes
	trigger = {
		scope:landed_title = {
			has_variable = kingsguard
		}
	}
	immediate = {
		scope:landed_title = {
			if = {
				limit = {
					exists = var:kingsguard_lord_commander
				}
				remove_variable = kingsguard_lord_commander
			}
			if = {
				limit = {
					exists = var:kingsguard_1
				}
				remove_variable = kingsguard_1
			}
			if = {
				limit = {
					exists = var:kingsguard_2
				}
				remove_variable = kingsguard_2
			}
			if = {
				limit = {
					exists = var:kingsguard_3
				}
				remove_variable = kingsguard_3
			}
			if = {
				limit = {
					exists = var:kingsguard_4
				}
				remove_variable = kingsguard_4
			}
			if = {
				limit = {
					exists = var:kingsguard_5
				}
				remove_variable = kingsguard_5
			}
			if = {
				limit = {
					exists = var:kingsguard_6
				}
				remove_variable = kingsguard_6
			}
		}
		every_councillor = {
			limit = {
				is_kingsguard_trigger = yes
				has_trait = kingsguard
			}
			remove_trait = kingsguard
			agot_kingsguard_destroy_artifacts = yes
		}
		if = {
			limit = {
				scope:landed_title = title:e_the_iron_throne
				exists = title:d_kingsguard.holder
			}
			title:d_kingsguard.holder = {
				destroy_title = title:d_kingsguard
			}
		}
		if = {
			limit = {
				scope:landed_title = title:e_valyria
				exists = title:d_draconicguard.holder
			}
			title:d_kingsguard.holder = {
				destroy_title = title:d_draconicguard
			}
		}
	}
}

agot_kingsguard.9007 = {
	#Grab lost kingsguard send them home
	hidden = yes
	trigger = {
		any_held_title = {
			tier = tier_empire
			has_variable = kingsguard
		}
	}
	immediate = {
		random_held_title = {
			limit = {
				tier = tier_empire
				has_variable = kingsguard
			}
			save_scope_as = kingsguard_title
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_lord_commander
				}
				scope:kingsguard_title.var:kingsguard_lord_commander = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_lord_commander = {
						NOT = {
							employer ?= root
							is_ruler = yes
						}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_lord_commander
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_lord_commander = {
							has_council_position = kingsguard_lord_commander
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_lord_commander
					target = scope:kingsguard_title.var:kingsguard_lord_commander
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_1
				}
				scope:kingsguard_title.var:kingsguard_1 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_1 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_1
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_1 = {
							has_council_position = kingsguard_1
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_1
					target = scope:kingsguard_title.var:kingsguard_1
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_2
				}
				scope:kingsguard_title.var:kingsguard_2 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_2 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_2
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_2 = {
							has_council_position = kingsguard_2
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_2
					target = scope:kingsguard_title.var:kingsguard_2
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_3
				}
				scope:kingsguard_title.var:kingsguard_3 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_3 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_3
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_3 = {
							has_council_position = kingsguard_3
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_3
					target = scope:kingsguard_title.var:kingsguard_3
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_4
				}
				scope:kingsguard_title.var:kingsguard_4 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_4 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_4
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_4 = {
							has_council_position = kingsguard_4
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_4
					target = scope:kingsguard_title.var:kingsguard_4
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_5
				}
				scope:kingsguard_title.var:kingsguard_5 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_5 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_5
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_5 = {
							has_council_position = kingsguard_5
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_5
					target = scope:kingsguard_title.var:kingsguard_5
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_6
				}
				scope:kingsguard_title.var:kingsguard_6 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_6 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_6
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_6 = {
							has_council_position = kingsguard_6
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_6
					target = scope:kingsguard_title.var:kingsguard_6
				}
			}
		}
		title:d_kingsguard.holder ?= {
			if = {
				limit = { NOT = { has_government = kingsguard_government } }
				change_government = kingsguard_government
			}
		}
		title:d_draconicguard.holder ?= {
			if = {
				limit = { NOT = { has_government = kingsguard_government } }
				change_government = kingsguard_government
			}
		}
		#Succession Display
		if = {
			limit = {
				exists = cp:kingsguard_lord_commander
				cp:kingsguard_lord_commander = {
					scope:kingsguard_title = title:d_kingsguard
				}
			}
			else_if = {
				limit = {
					exists = cp:kingsguard_lord_commander
					cp:kingsguard_lord_commander = {
						scope:kingsguard_title = title:d_draconicguard
					}
				}
			}
			if = {
				limit = {
					scope:kingsguard_title = {
						exists = var:kingsguard_1
					}
					scope:kingsguard_title.var:kingsguard_1 = {
						is_alive = yes
					}
				}
				scope:kingsguard_title.var:kingsguard_1 = {
					add_to_list = kingsguard_successor
				}
			}
			if = {
				limit = {
					scope:kingsguard_title = {
						exists = var:kingsguard_2
					}
					scope:kingsguard_title.var:kingsguard_2 = {
						is_alive = yes
					}
				}
				scope:kingsguard_title.var:kingsguard_2 = {
					add_to_list = kingsguard_successor
				}
			}
			if = {
				limit = {
					scope:kingsguard_title = {
						exists = var:kingsguard_3
					}
					scope:kingsguard_title.var:kingsguard_3 = {
						is_alive = yes
					}
				}
				scope:kingsguard_title.var:kingsguard_3 = {
					add_to_list = kingsguard_successor
				}
			}
			if = {
				limit = {
					scope:kingsguard_title = {
						exists = var:kingsguard_4
					}
					scope:kingsguard_title.var:kingsguard_4 = {
						is_alive = yes
					}
				}
				scope:kingsguard_title.var:kingsguard_4 = {
					add_to_list = kingsguard_successor
				}
			}
			if = {
				limit = {
					scope:kingsguard_title = {
						exists = var:kingsguard_5
					}
					scope:kingsguard_title.var:kingsguard_5 = {
						is_alive = yes
					}
				}
				scope:kingsguard_title.var:kingsguard_5 = {
					add_to_list = kingsguard_successor
				}
			}
			if = {
				limit = {
					scope:kingsguard_title = {
						exists = var:kingsguard_6
					}
					scope:kingsguard_title.var:kingsguard_6 = {
						is_alive = yes
					}
				}
				scope:kingsguard_title.var:kingsguard_6 = {
					add_to_list = kingsguard_successor
				}
			}
			ordered_in_list  = {
				list = kingsguard_successor
				order_by = prowess
				max = 1
				save_scope_as = kingsguard_successor
			}
			cp:kingsguard_lord_commander = {
				set_designated_heir = scope:kingsguard_successor
			}
		}
	}
}

agot_kingsguard.9008 = {
	# agot_on_title_gain_kingsguard = { # This only works if the previous owner has a title to fall back on, and thus, has a court
	hidden = yes

	trigger = {
		any_held_title = {
			tier = tier_empire
			has_variable = kingsguard
		}
	}

	immediate = {
		random_held_title = {
			limit = {
				tier = tier_empire
				has_variable = kingsguard
			}
			save_scope_as = kingsguard_title
		}
		if = { #Ensure Kingsguard title is a vassal
			limit = {
				has_title = title:e_the_iron_throne
				NOT = { has_title = title:d_kingsguard }
				exists = title:d_kingsguard.holder
			}
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
				add_claim_on_loss = no
			}
			title:d_kingsguard.holder = {
				change_liege = {
					liege = root
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
		}
		else_if = { #Ensure Kingsguard title is a vassal
			limit = {
				has_title = title:e_valyria
				NOT = { has_title = title:d_draconicguard }
				exists = title:d_draconicguard.holder
			}
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
				add_claim_on_loss = no
			}
			title:d_draconicguard.holder = {
				change_liege = {
					liege = root
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_lord_commander
				}
				scope:kingsguard_title.var:kingsguard_lord_commander = {
					is_alive = yes
				}
			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_lord_commander = {
						NOT = { employer ?= root}
						is_ruler = no
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_lord_commander
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_lord_commander = {
							has_council_position = kingsguard_lord_commander
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_lord_commander
					target = scope:kingsguard_title.var:kingsguard_lord_commander
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_1
				}
				scope:kingsguard_title.var:kingsguard_1 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_1 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_1
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_1 = {
							has_council_position = kingsguard_1
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_1
					target = scope:kingsguard_title.var:kingsguard_1
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_2
				}
				scope:kingsguard_title.var:kingsguard_2 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_2 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_2
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_2 = {
							has_council_position = kingsguard_2
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_2
					target = scope:kingsguard_title.var:kingsguard_2
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_3
				}
				scope:kingsguard_title.var:kingsguard_3 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_3 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_3
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_3 = {
							has_council_position = kingsguard_3
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_3
					target = scope:kingsguard_title.var:kingsguard_3
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_4
				}
				scope:kingsguard_title.var:kingsguard_4 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_4 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_4
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_4 = {
							has_council_position = kingsguard_4
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_4
					target = scope:kingsguard_title.var:kingsguard_4
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_5
				}
				scope:kingsguard_title.var:kingsguard_5 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_5 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_5
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_5 = {
							has_council_position = kingsguard_5
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_5
					target = scope:kingsguard_title.var:kingsguard_5
				}
			}
		}
		if = {
			limit = {
				scope:kingsguard_title = {
					exists = var:kingsguard_6
				}
				scope:kingsguard_title.var:kingsguard_6 = {
					is_alive = yes
				}

			}
			if = {
				limit = {
					scope:kingsguard_title.var:kingsguard_6 = {
						NOT = { employer ?= root}
					}
				}
				add_courtier ?= scope:kingsguard_title.var:kingsguard_6
			}
			if = {
				limit = {
					NOT = {
						scope:kingsguard_title.var:kingsguard_6 = {
							has_council_position = kingsguard_6
						}
					}
				}
				assign_councillor_type = {
					type = kingsguard_6
					target = scope:kingsguard_title.var:kingsguard_6
				}
			}
		}
	}
}