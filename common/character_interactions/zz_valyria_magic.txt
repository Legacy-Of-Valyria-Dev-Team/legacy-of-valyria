## Teach Magic Decision 

zz_valyria_magic_01.interaction = {

	desc = zz_valyria_magic_01.interaction.interaction.desc
	icon = icon_magic
	#icon = blood_magic
	#icon = shadow_magic	
	#icon = dream_magic
	#icon = alchemy_magic 
	#icon = fire_magic
	#icon = air_magic
	#icon = water_magic
	common_interaction = yes
	interface_priority = 40000
	category = interaction_category_religion

	is_shown = {
		scope:actor = {
			is_ai = no
			
			is_imprisoned = no
			zz_valyria_is_mage = yes 
		}
		scope:recipient = {
		}	
	}
	is_valid_showing_failures_only = {
		scope:actor = {
			zz_valyria_is_mage = yes 
		}
	}
	

	cooldown_against_recipient = { days = 0 } 
	cooldown = { days = 0 } 
	ignores_pending_interaction_block = yes
	use_diplomatic_range = yes
	on_send = {
		scope:actor = {
			save_scope_as = zz_magic_user
			zz_valyria_make_mage_list =  {MAGIC_USER = zz_magic_user}
			zz_valyria_make_spell_list = {MAGIC_USER = zz_magic_user MAGIC_CASTER = zz_magic_caster}
			zz_valyria_make_item_caster_list = {MAGIC_USER = zz_magic_user}
			zz_valyria_make_scroll_list = {MAGIC_USER = zz_magic_user ITEM_CASTER = zz_item_caster}
			remove_variable = cast_type
			set_variable = {
				name = cast_type
				value = flag:mystery
			}
		}

		scope:recipient = {
			save_scope_as = zz_magic_target
		}
	}
	on_accept = {
		scope:actor = {
			set_variable = {
				name = zz_magic_ui
				value = flag:spell_casting
			}
			set_variable = {
				name = zz_magic_user
				value = scope:zz_magic_user
			}		

			set_variable = {
				name = zz_magic_target
				value = scope:zz_magic_target
			}
			set_variable = {
				name = zz_valyria_mystery_cost
				value = var:zz_valyria_mystery.var:manacost
			}
		}
	}
	auto_accept = yes
	ai_targets = {
		ai_recipients = self
	}

	ai_frequency = 12

	ai_will_do = {
		base = 0

	}
}
valyria_magic_self_wounding = {
	is_shown = {
		scope:recipient = {
			has_trait = zz_magister
			is_imprisoned = no
			NOT = { 
				has_trait = dragon
			}
			OR = {
				top_liege = scope:actor
				this = scope:actor
			}
		}
		scope:actor = {
			is_ai = no
		}
	}
	is_valid_showing_failures_only = {
		scope:recipient  = {
			has_trait = zz_magister
		}
	}
	icon = icon_magic
	common_interaction = yes
	interface_priority = 25000
	category = interaction_category_religion
	
	cooldown_against_recipient = { days = 30 } 
	cooldown = { years = 0 } 
	ignores_pending_interaction_block = yes
	use_diplomatic_range = yes
	on_accept = {
		scope:actor = {
			scope:recipient = {
				random = {
					chance = 50
					increase_wounds_effect = { REASON = blood_magic }
				}				
				if = {
					limit = {
						OR = {
							agot_is_dragonblood_character = yes
							agot_has_dragonblood_heritage = yes 
						}
					}
					zz_valyria_mana_gain = {
						MANAGAIN = 3
					}
				}
				else ={
					zz_valyria_mana_gain = {
						MANAGAIN = 1
					}
				}

			}
		}
	}
	auto_accept = yes
	ai_targets = {
		ai_recipients = self
	}

	ai_frequency = 12

	ai_will_do = {
		base = 0

	}
}

valyria_magic_teach_decision = {
	icon = icon_magic
	common_interaction = yes
	interface_priority = 20000
	category = interaction_category_religion
	populate_recipient_list = {
		scope:actor = { 
			zz_valyria_populate_mage_list_can_teach = yes
		}
	}
	is_shown = {
		scope:actor = {
			zz_valyria_is_mage_can_teach = yes 
			is_imprisoned = no
			is_ai = no
		}
		scope:recipient = {
			NOT = { 
				has_trait = zz_magister
				has_trait = dragon
			}
		}	
	}
	is_valid_showing_failures_only = {
		scope:actor = {
			zz_valyria_is_mage_can_teach = yes 
		}
	}
	cost = {
		piety = massive_piety_value
		gold = massive_gold_max_value
	}

	cooldown_against_recipient = { days = 0 } 
	cooldown = { years = 0 } 
	ignores_pending_interaction_block = yes
	use_diplomatic_range = yes
	on_accept = {
		scope:secondary_recipient = {
			add_character_flag = { flag = zz_valyria_magic_taught_magic months = 72 } 
		}
		scope:actor = {
			scope:recipient = {
				add_trait_force_tooltip = zz_magister
				zz_random_gain_magic_spell = yes
			}
			
		}
	}
	auto_accept = yes
	ai_targets = {
		ai_recipients = self
	}

	ai_frequency = 12

	ai_will_do = {
		base = 0
	}
}

valyria_magic_teach_spell = {
	icon = icon_magic
	common_interaction = yes
	interface_priority = 15000
	category = interaction_category_religion

	is_shown = {
		scope:actor = {
			is_ai = no
			is_imprisoned = no
		}
		scope:recipient = {
			has_trait = zz_magister
			NOT = { 
				has_trait = dragon
			}
		}	
	}
	is_valid_showing_failures_only = {
		scope:recipient = {
			has_trait = zz_magister
		}	
		scope:actor = {
			zz_valyria_is_mage_can_teach = yes 
		}
	}
	cost = {
		piety = minor_piety_value
	}	
	cooldown_against_recipient = { days = 0 } 
	cooldown = { days = 0 } 
	ignores_pending_interaction_block = yes
	use_diplomatic_range = yes
	on_accept = {
		scope:actor = {
			save_scope_as = zz_magic_user
		}
		scope:recipient = {
			save_scope_as = zz_magic_learner
		}
		scope:actor = {
			remove_variable = zz_magic_teacher
			remove_variable = zz_magic_learner
			remove_variable = zz_magic_user

			set_variable = {
				name = zz_magic_user
				value = scope:zz_magic_user
			}
			set_variable = {
				name = zz_magic_learner
				value = scope:zz_magic_learner
			}			
			if = { 
				limit = {
					has_trait = zz_magister
					NOT = {
						THIS = scope:zz_magic_learner 
					}
				}
				scope:actor = {
					add_to_variable_list = {
						name = mage_list
						target = prev
					}
				}
			}
			every_living_mage = {
				limit = {
					liege_or_court_owner ?= scope:actor
					NOT = {
						THIS = scope:zz_magic_learner 
					}
				}
				scope:actor = {
					add_to_variable_list = {
						name = mage_list
						target = prev
					}
				}
			}
			ordered_in_list = {
				variable = mage_list
				position = 0
				order_by = learning
				save_scope_as = zz_magic_teacher
			}
			clear_variable_list ?= zz_valyria_spell_list
			scope:zz_magic_teacher = {
				every_memory = {
					limit = { 
						has_memory_category = magic
					}
					scope:actor = {
						add_to_variable_list = {
							name = zz_valyria_spell_list
							target = prev
						}
						if = {
							limit = {
								NOT = { has_variable = zz_valyria_mystery }
							}
							set_variable = { name = zz_valyria_mystery value = prev }
						}
					}
				}
			}
		}
	}
	auto_accept = yes
	ai_targets = {
		ai_recipients = self
	}

	ai_frequency = 12

	ai_will_do = {
		base = 0

	}
}


