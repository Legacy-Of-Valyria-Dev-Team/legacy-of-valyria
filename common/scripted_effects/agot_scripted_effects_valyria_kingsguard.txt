agot_assign_lord_commander_effect = {
	$COMMANDER$ = {
		create_character_memory = {
			type = agot_kingsguard_lord_commander_memory
			participants = {
				king = $KING$
			}
		}
		if = {
			limit = {
				any_artifact = {
					has_variable = white_book
					count = 0
				}
			}
			agot_recreate_artifact_the_white_book_effect = yes
		}
		add_character_flag = lord_commander
	}

	$KING$ = {
		primary_title = {
			if = {
				limit = {
					exists = var:kingsguard_1
					var:kingsguard_1 = $COMMANDER$
				}
				remove_variable = kingsguard_1
			}
			else_if = {
				limit = {
					exists = var:kingsguard_2
					var:kingsguard_2 = $COMMANDER$
				}
				remove_variable = kingsguard_2
			}
			else_if = {
				limit = {
					exists = var:kingsguard_3
					var:kingsguard_3 = $COMMANDER$
				}
				remove_variable = kingsguard_3
			}
			else_if = {
				limit = {
					exists = var:kingsguard_4
					var:kingsguard_4 = $COMMANDER$
				}
				remove_variable = kingsguard_4
			}
			else_if = {
				limit = {
					exists = var:kingsguard_5
					var:kingsguard_5 = $COMMANDER$
				}
				remove_variable = kingsguard_5
			}
			else_if = {
				limit = {
					exists = var:kingsguard_6
					var:kingsguard_6 = $COMMANDER$
				}
				remove_variable = kingsguard_6
			}

			set_variable = {
				name = kingsguard_lord_commander
				value = $COMMANDER$
			}
		}

		random_character_artifact = {
			limit = {
				has_variable = white_book
			}
			set_owner = $COMMANDER$
			save_scope_as = white_book
		}

		assign_councillor_type = {
			type = kingsguard_lord_commander
			target = $COMMANDER$
		}
	}

	$KING$ = {
		if = {
			limit = { primary_title = title:e_the_iron_throne }
			hidden_effect = {
				title:d_kingsguard = {
					copy_title_history = title:d_dummy_kingsguard
				}
			}
			create_title_and_vassal_change = {
				type = granted
				save_scope_as = change
			}
			title:d_kingsguard = {
				change_title_holder = {
					holder = $COMMANDER$
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change

			title:d_kingsguard = {
				set_coa = d_kingsguard
			}
			hidden_effect = {
				title:d_dummy_kingsguard = {
					copy_title_history = title:d_kingsguard
				}
			}
		}
		if = {
			limit = {  primary_title = title:e_valyria }
			hidden_effect = {
				title:d_draconicguard = {
					copy_title_history = title:d_dummy_kingsguard2
				}
			}
			create_title_and_vassal_change = {
				type = granted
				save_scope_as = change
			}
			title:d_draconicguard = {
				change_title_holder = {
					holder = $COMMANDER$
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
		
			title:d_draconicguard = {
				set_coa = d_kingsguard
			}
			hidden_effect = {
				title:d_dummy_kingsguard2 = {
					copy_title_history = title:d_draconicguard
				}
			}
		}
	}

	#destroy_title = title:d_kingsguard

	assign_councillor_type = {
		type = kingsguard_lord_commander
		target = scope:title.var:kingsguard_lord_commander
	}

	$KING$ = { trigger_event = agot_kingsguard.9007 } #grab back the lord commander you yeeted
	$KING$ = { trigger_event = agot_kingsguard.9008 }
}

agot_remove_kingsguard_effect = {
	$KINGSGUARD$ = { save_scope_as = removed_kg }

	scope:removed_kg = {
		if = {
			limit = {
				OR = {
					has_council_position = kingsguard_lord_commander
					has_character_flag = lord_commander
				}
			}
			white_book_transfer = yes
			save_scope_as = kg_is_lord_commander
		}
	}

	scope:removed_kg = {
		if = {
			limit = {
				NOT = { exists = scope:dead_kingsguard }
			}

			remove_trait = kingsguard
			agot_kingsguard_destroy_artifacts = yes
			add_character_flag = can_fire_kingsguard
			title:e_the_iron_throne.holder = {
				if = {
					limit = {
						prev = { is_councillor_of = title:e_the_iron_throne.holder }
					}
					fire_councillor = prev
				}
			}
			title:e_valyria.holder = {
				if = {
					limit = {
						prev = { is_councillor_of = title:e_valyria.holder }
					}
					fire_councillor = prev
				}
			}
		}
	}

	title:e_the_iron_throne = {
		if = {
			limit = {
				exists = var:kingsguard_lord_commander
				var:kingsguard_lord_commander = scope:removed_kg
			}
			remove_variable = kingsguard_lord_commander
		}
		else_if = {
			limit = {
				exists = var:kingsguard_1
				var:kingsguard_1 = scope:removed_kg
			}
			remove_variable = kingsguard_1
		}
		else_if = {
			limit = {
				exists = var:kingsguard_2
				var:kingsguard_2 = scope:removed_kg
			}
			remove_variable = kingsguard_2
		}
		else_if = {
			limit = {
				exists = var:kingsguard_3
				var:kingsguard_3 = scope:removed_kg
			}
			remove_variable = kingsguard_3
		}
		else_if = {
			limit = {
				exists = var:kingsguard_4
				var:kingsguard_4 = scope:removed_kg
			}
			remove_variable = kingsguard_4
		}
		else_if = {
			limit = {
				exists = var:kingsguard_5
				var:kingsguard_5 = scope:removed_kg
			}
			remove_variable = kingsguard_5
		}
		else_if = {
			limit = {
				exists = var:kingsguard_6
				var:kingsguard_6 = scope:removed_kg
			}
			remove_variable = kingsguard_6
		}
	}

	title:e_valyria = {
		if = {
			limit = {
				exists = var:kingsguard_lord_commander
				var:kingsguard_lord_commander = scope:removed_kg
			}
			remove_variable = kingsguard_lord_commander
		}
		else_if = {
			limit = {
				exists = var:kingsguard_1
				var:kingsguard_1 = scope:removed_kg
			}
			remove_variable = kingsguard_1
		}
		else_if = {
			limit = {
				exists = var:kingsguard_2
				var:kingsguard_2 = scope:removed_kg
			}
			remove_variable = kingsguard_2
		}
		else_if = {
			limit = {
				exists = var:kingsguard_3
				var:kingsguard_3 = scope:removed_kg
			}
			remove_variable = kingsguard_3
		}
		else_if = {
			limit = {
				exists = var:kingsguard_4
				var:kingsguard_4 = scope:removed_kg
			}
			remove_variable = kingsguard_4
		}
		else_if = {
			limit = {
				exists = var:kingsguard_5
				var:kingsguard_5 = scope:removed_kg
			}
			remove_variable = kingsguard_5
		}
		else_if = {
			limit = {
				exists = var:kingsguard_6
				var:kingsguard_6 = scope:removed_kg
			}
			remove_variable = kingsguard_6
		}
	}

	title:e_the_iron_throne.holder = {
		if = {
			limit = {
				is_ai = yes
				exists = scope:kg_is_lord_commander
			}
			create_title_and_vassal_change = {
				type = granted
				save_scope_as = change
			}
			title:d_kingsguard = {
				change_title_holder = {
					holder = title:e_the_iron_throne.holder
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change

			trigger_event = {
				id = agot_kingsguard.9001
				days = 3
			}
		}
		else_if = {
			limit = {
				exists = scope:kg_is_lord_commander
			}
			title:d_dummy_kingsguard = {
				copy_title_history = title:d_kingsguard
			}
			destroy_title = title:d_kingsguard
			title:d_kingsguard = {
				copy_title_history = title:d_dummy_kingsguard
			}
			trigger_event = {
				id = agot_kingsguard.1010
				delayed = yes
			}
		}

		if = {
			limit = {
				is_ai = yes
			}
			trigger_event = {
				id = agot_kingsguard.9002
				days = 4
			}
		}
		else = {
			trigger_event = agot_kingsguard.1001
		}
	}

	title:e_valyria.holder = {
		if = {
			limit = {
				is_ai = yes
				exists = scope:kg_is_lord_commander
			}
			create_title_and_vassal_change = {
				type = granted
				save_scope_as = change
			}
			title:d_draconicguard = {
				change_title_holder = {
					holder = title:e_valyria.holder
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change

			trigger_event = {
				id = agot_kingsguard.9001
				days = 3
			}
		}
		else_if = {
			limit = {
				exists = scope:kg_is_lord_commander
			}
			title:d_dummy_kingsguard2 = {
				copy_title_history = title:d_draconicguard
			}
			destroy_title = title:d_draconicguard
			title:d_draconicguard = {
				copy_title_history = title:d_dummy_kingsguard2
			}
			trigger_event = {
				id = agot_kingsguard.1010
				delayed = yes
			}
		}

		if = {
			limit = {
				is_ai = yes
			}
			trigger_event = {
				id = agot_kingsguard.9002
				days = 4
			}
		}
		else = {
			trigger_event = agot_kingsguard.1001
		}
	}
}