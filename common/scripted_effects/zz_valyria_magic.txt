zz_valyria_mana_gain = {
	if = {
		limit = {
			has_trait = zz_magister
			has_trait_xp = {
				trait = zz_magister
				track = drops_of_power
				value < 100
			}
		}
		add_trait_xp = {
			trait = zz_magister
			track = drops_of_power
			value =  $MANAGAIN$
		}
	}
	else_if = {
		limit ={
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_01
				value  < 100
			}
		}
		add_trait_xp = {
			trait = born_under_a_red_comet
			track = stores_of_power_01
			value = $MANAGAIN$
		}
	}
	else_if = {
		limit ={
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_02
				value  < 100
			}
		}
		add_trait_xp = {
			trait = born_under_a_red_comet
			track = stores_of_power_02
			value = $MANAGAIN$
		}
	}
	else_if = {
		limit ={
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_03
				value  < 100
			}
		}
		add_trait_xp = {
			trait = born_under_a_red_comet
			track = stores_of_power_03
			value = $MANAGAIN$
		}
	}
	else_if = {
		limit ={
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_04
				value  < 100
			}
		}
		add_trait_xp = {
			trait = born_under_a_red_comet
			track = stores_of_power_04
			value = $MANAGAIN$
		}
	}
	else_if = {
		limit ={
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_05
				value  < 100
			}
		}
		add_trait_xp = {
			trait = born_under_a_red_comet
			track = stores_of_power_05
			value = $MANAGAIN$
		}
	}
	else_if = {
		limit ={
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_06
				value  < 100
			}
		}
		add_trait_xp = {
			trait = born_under_a_red_comet
			track = stores_of_power_06
			value = $MANAGAIN$
		}
	}
	else_if = {
		limit = {
			NOR = {
				has_character_modifier = zz_valyria_magic_drops_power
			}
		}
		add_character_modifier = zz_valyria_magic_drops_power
	}
}

zz_valyria_mana_spend = {
	set_variable = { 
		name = manacost
		value = $MANACOST$
	}
	if = {
		limit = {
			OR = {
				has_character_modifier = zz_valyria_magic_drops_power
			}
		}
		remove_character_modifier = zz_valyria_magic_drops_power
	}
	else_if  = { 
		limit =  { 
			has_trait = born_under_a_red_comet 
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_06
				value >=$MANACOST$
			}
		}
		
		hidden_effect = {
			add_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_06
				value = zz_spend_mana 
			}
		}
	}
	else_if  = { 
		limit =  { 
			has_trait = born_under_a_red_comet 
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_05
				value >=$MANACOST$
			}
		}
		
		hidden_effect = {
			add_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_05
				value = zz_spend_mana 
			}
		}
	}
	else_if  = { 
		limit =  { 
			has_trait = born_under_a_red_comet 
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_04
				value >=$MANACOST$
			}
		}
		
		hidden_effect = {
			add_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_04
				value = zz_spend_mana 
			}
		}
	}
	else_if  = { 
		limit =  { 
			has_trait = born_under_a_red_comet 
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_03
				value >=$MANACOST$
			}
		}
		hidden_effect = {
			add_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_03
				value = zz_spend_mana 
			}
		}
	}
	else_if  = { 
		limit =  { 
			has_trait = born_under_a_red_comet 
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_02
				value >=$MANACOST$
			}
		}
		hidden_effect = {
			add_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_02
				value = zz_spend_mana 
			}
		}
	}
	else_if  = { 
		limit =  { 
			has_trait = born_under_a_red_comet 
			has_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_01
				value >=$MANACOST$
			}
		}
		hidden_effect = {
			add_trait_xp = {
				trait = born_under_a_red_comet
				track = stores_of_power_01
				value = zz_spend_mana 
			}
		}
	}
	else_if  = { 
		limit =  { 
			has_trait = zz_magister 
		}
		hidden_effect = {
			add_trait_xp = {
				trait = zz_magister
				track = drops_of_power
				value = zz_spend_mana 
			}
		}
	}
}

zz_valyria_gain_spell_experience = { 
	add_trait_xp = { 
		trait = zz_magister 
		track = $XPTRACK$ 
		value = $XPGAIN$ 
	}
}


zz_valyria_magic_cast_effect = { 
	random_list = { 
		40 = { 
			modifier = {
				add = zz_spellcast_value
			}
			$SPELL$_effect = yes
		}
		60 = { 
			zz_valyria_spell_failure_effect = yes
		}
	}
}

zz_valyria_populate_mage_list = { 
	if = { 
		limit = {
			has_trait = zz_magister
		}
		add_to_list = characters
	}
	every_living_mage = { 
		limit = { 
			liege_or_court_owner ?= scope:actor 
		}
		add_to_list = characters
	}
}

zz_valyria_populate_mage_list_can_teach = { 
	if = { 
		limit = {
			has_trait = zz_magister
			NOT = { 
				has_character_flag = zz_valyria_magic_taught_magic 
			}
		}
		add_to_list = characters
	}
	every_living_mage = { 
		limit = { 
			liege_or_court_owner ?= scope:actor 
			NOT = { 
				has_character_flag = zz_valyria_magic_taught_magic 
			}
		}
		add_to_list = characters
	}
}


zz_valyria_populate_spell_caster_list = {
	if = { 
		limit = {
			zz_valyria_valid_caster = {
				SPELL = $SPELL$
				MANACOST = $MANACOST$
			}
		}
		add_to_list = characters
	}
	every_living_mage = { 
		limit = { 
			liege_or_court_owner ?= scope:actor 
			zz_valyria_valid_caster = {
				SPELL = $SPELL$
				MANACOST = $MANACOST$
			}
		}
		add_to_list = characters
	}
}

zz_valyria_populate_spell_recipient_list = {
	scope:recipient = {
		add_to_list = characters
	}
	scope:actor = {
		add_to_list = characters
		every_courtier = {
			add_to_list = characters
		}
		every_child = {
			add_to_list = characters
		}
	}
}

zz_dragon_dreams = {
	remove_character_flag = dreamt
}





zz_add_spell = {
	if = {
		limit = {
			NOR  = {
				any_memory = {
					has_memory_type = $SPELL$
				}
				has_character_flag = $SPELL$_flag
			}
		}
		save_scope_as = spell_learner
		send_interface_message = {
			type = event_generic_neutral
			title = learn_$SPELL$.t
			desc = learn_$SPELL$.desc
			left_icon = scope:spell_learner
			right_icon = scope:spell_learner
			custom_tooltip = learn_$SPELL$.tt
			#add_character_flag =  $SPELL$_flag
			scope:spell_learner = {
				create_character_memory = {
					type = $SPELL$
				}
				scope:new_memory = {
					set_variable = {
						name = learning_location
						value = scope:spell_learner.location
					}
				}
				scope:activity ?= {
					add_activity_log_entry = {
						key = learn_$SPELL$.t
						score = 25
						tags = { good learning activity }
						character = root
						#Effect
						custom_tooltip = learn_$SPELL$.t
					}
				}
			}
		}		
	}
}


zz_gain_blood_magic_spell = { 
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_01_mysteries_of_restoration
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_01_mysteries_of_restoration
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_02_mysteries_of_transmogrification
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_02_mysteries_of_transmogrification
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_03_mysteries_of_regeneration
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_03_mysteries_of_regeneration
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_04_mysteries_of_renewal
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_04_mysteries_of_renewal
			}
		}	
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_05_mysteries_of_replication
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_05_mysteries_of_replication
			}
		}	
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_06_mysteries_of_draconic_rejuvenation
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_06_mysteries_of_draconic_rejuvenation
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_07_mysteries_of_enchanted_blood
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_07_mysteries_of_enchanted_blood
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_08_mysteries_of_dragon_laying
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_blood_magic_08_mysteries_of_dragon_laying
			}
		}
	}
}

zz_gain_shadow_magic_spell = { 
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_01_mysteries_of_shadowy_steeds
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_shadow_magic_01_mysteries_of_shadowy_steeds
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_02_mysteries_of_shadowy_daggers
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_shadow_magic_02_mysteries_of_shadowy_daggers
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_03_mysteries_of_the_shadow_shield
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_shadow_magic_03_mysteries_of_the_shadow_shield
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_04_mysteries_of_the_shadowy_cloak
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_shadow_magic_04_mysteries_of_the_shadowy_cloak
			}
		}
	}
}

zz_gain_dream_magic_spell = { 
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_02_mysteries_of_dreaming_destinies
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_dream_magic_02_mysteries_of_dreaming_destinies
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_04_mysteries_of_secrets
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_dream_magic_04_mysteries_of_secrets
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_03_mysteries_of_dreams
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_dream_magic_03_mysteries_of_dreams
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_01_mysteries_mental_domination
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_dream_magic_01_mysteries_mental_domination
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_05_mysteries_of_personality_distortion
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_dream_magic_05_mysteries_of_personality_distortion
			}
		}
	}
}

zz_gain_alchemy_spell = { 
	random_list = { 
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_04_mysteries_of_arms
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_alchemy_magic_04_mysteries_of_arms
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_02_mysteries_of_construction
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_alchemy_magic_02_mysteries_of_construction
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_01_mysteries_of_growth
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_alchemy_magic_01_mysteries_of_growth
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_03_mysteries_of_transmutation
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_alchemy_magic_03_mysteries_of_transmutation
			}
		}
	}
}
zz_gain_fire_magic_spell = { 
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_fire_magic_01_mysteries_of_striking_flame
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_fire_magic_01_mysteries_of_striking_flame
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_fire_magic_02_mysteries_of_the_blasting_flame
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_fire_magic_02_mysteries_of_the_blasting_flame
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_fire_magic_03_mysteries_of_the_storm_of_fire
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_fire_magic_03_mysteries_of_the_storm_of_fire
			}
		}
	}
}
zz_gain_water_magic_spell = { 
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_water_magic_02_mysteries_of_the_surging_torrent
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_water_magic_02_mysteries_of_the_surging_torrent
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_water_magic_01_mysteries_of_the_crushing_waters
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_water_magic_01_mysteries_of_the_crushing_waters
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_water_magic_03_mysteries_of_endurance
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_water_magic_03_mysteries_of_endurance
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_water_magic_04_mysteries_of_rhoyne
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_water_magic_04_mysteries_of_rhoyne
			}
		}

		
	}
}

zz_gain_air_magic_spell = { 
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_air_magic_02_mysteries_of_the_tempestuous_winds
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_air_magic_02_mysteries_of_the_tempestuous_winds
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_air_magic_01_mysteries_of_the_slicing_wind
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = zz_valyria_magic_air_magic_01_mysteries_of_the_slicing_wind
			}
		}
	}
}

zz_random_gain_magic_spell = {
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_01_mysteries_of_restoration
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_02_mysteries_of_transmogrification
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_03_mysteries_of_regeneration
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_04_mysteries_of_renewal
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_05_mysteries_of_replication
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_06_mysteries_of_draconic_rejuvenation
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_07_mysteries_of_enchanted_blood				
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_blood_magic_08_mysteries_of_dragon_laying				
				}
				add = -100
			}
			zz_gain_blood_magic_spell = yes 
		}
		100 = { 
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_01_mysteries_of_shadowy_steeds
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_02_mysteries_of_shadowy_daggers
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_03_mysteries_of_the_shadow_shield
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_shadow_magic_04_mysteries_of_the_shadowy_cloak
				}
				add = -100
			}
			zz_gain_shadow_magic_spell = yes 
		}
		100 = { 
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_01_mysteries_mental_domination
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_02_mysteries_of_dreaming_destinies
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_03_mysteries_of_dreams
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_04_mysteries_of_secrets
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_dream_magic_05_mysteries_of_personality_distortion
				}
				
				add = -100
			}
			zz_gain_dream_magic_spell = yes 
		}
		100 = { 
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_01_mysteries_of_growth
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_02_mysteries_of_construction
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_03_mysteries_of_transmutation
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_alchemy_magic_04_mysteries_of_arms
				}
				add = -100
			}
			zz_gain_alchemy_spell = yes 
		}
		100 = { 
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_fire_magic_01_mysteries_of_striking_flame
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_fire_magic_02_mysteries_of_the_blasting_flame
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_fire_magic_03_mysteries_of_the_storm_of_fire
				}
				add = -100
			}
			zz_gain_fire_magic_spell = yes
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_water_magic_01_mysteries_of_the_crushing_waters
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_water_magic_02_mysteries_of_the_surging_torrent
				}
				zz_valyria_knows_spell = {
					SPELL = zz_valyria_magic_water_magic_03_mysteries_of_endurance
				}
				zz_valyria_knows_spell = {
					SPELL = zz_valyria_magic_water_magic_04_mysteries_of_rhoyne
				}
				add = -100
			}
			zz_gain_water_magic_spell  = yes 
		}
		100 = { 
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_air_magic_01_mysteries_of_the_slicing_wind
				}
				zz_valyria_knows_spell  = {
					SPELL = zz_valyria_magic_air_magic_02_mysteries_of_the_tempestuous_winds
				}
				add = -100
			}
			zz_gain_air_magic_spell = yes
		}			
	}
}

