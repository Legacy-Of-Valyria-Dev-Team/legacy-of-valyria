zz_valyria_mana_gain = {
	if = {
		limit = {
			has_trait = zz_magister
			has_trait_xp = {
				trait = zz_magister
				track = drops_of_power
				value < 100
			}
		}
		set_variable = { 
			name = managain
			value = $MANAGAIN$
		}
		add_trait_xp = {
			trait = zz_magister
			track = drops_of_power
			value = zz_valyria_mana_gain_modifier
		}
	}
	else_if = {
		limit = {
			NOR = {
				has_character_modifier = zz_valyria_magic_drops_power
			}
		}
		add_character_modifier = zz_valyria_magic_drops_power
	}
}

zz_valyria_mana_spend = {
	if = {
		limit = {
			OR = {
				has_character_modifier = zz_valyria_magic_drops_power
			}
		}
		remove_character_modifier = zz_valyria_magic_drops_power
	}
	
	else_if  = { 
		limit =  { 
			has_trait = zz_magister 
			has_trait_xp = {
				trait = zz_magister
				track = drops_of_power
				value >= $MANACOST$
			}
		}
		set_variable = { 
			name = manacost
			value = $MANACOST$
		}
		hidden_effect = {
			add_trait_xp = {
				trait = zz_magister
				track = drops_of_power
				value = zz_spend_mana 
			}
		}
	}
}

zz_valyria_gain_spell_experience = { 
	add_trait_xp = { 
		trait = zz_magister 
		track = $XPTRACK$ 
		value = $XPGAIN$ 
	}
}

zz_valyria_populate_mage_list = { 
	if = { 
		limit = {
			has_trait = zz_magister
		}
		add_to_list = characters
	}
	every_living_mage = { 
		limit = { 
			liege_or_court_owner ?= scope:actor 
		}
		add_to_list = characters
	}
}


zz_valyria_populate_spell_caster_list = {
	if = { 
		limit = {
			zz_valyria_valid_caster = {
				SPELL = $SPELL$
				MANACOST = $MANACOST$
			}
		}
		add_to_list = characters
	}
	every_courtier = {
		limit = {
			zz_valyria_valid_caster = {
				SPELL = $SPELL$
				MANACOST = $MANACOST$
			}
		}
		add_to_list = characters
	}
	every_child = {
		limit = {
			zz_valyria_valid_caster = {
				SPELL = $SPELL$
				MANACOST = $MANACOST$
			}
		}
		add_to_list = characters
	}
}

zz_valyria_populate_spell_recipient_list = {
	scope:recipient = {
		add_to_list = characters
	}
	scope:actor = {
		add_to_list = characters
		every_courtier = {
			add_to_list = characters
		}
		every_child = {
			add_to_list = characters
		}
	}
}

zz_dragon_dreams = {
	remove_character_flag = dreamt
}

zz_add_spell = {
	if = {
		limit = {
			NOT  = {
				has_character_flag = $SPELL$
			}
		}
		add_character_flag =  $SPELL$
	}
}


zz_spell_cast = { 
	remove_variable = spellcast
	if = { 
		limit = { 
			zz_spellcast_value >= 100
		}
		set_variable = spellcast
	}
}


zz_random_gain_magic_spell = {
	random_list = {
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = healing_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = healing_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = empowerment_of_arms_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = empowerment_of_arms_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = genetic_manipulation_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = genetic_manipulation_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = building_speed_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = building_speed_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = development_boost_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = development_boost_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = transmutation_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = transmutation_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = dreaming_within_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = dreaming_within_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = secrets_of_dreams_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = secrets_of_dreams_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = dreams_of_experience_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = dreams_of_experience_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = flame_strike_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = flame_strike_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = mental_domination_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = mental_domination_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = waters_of_mother_rhoyne_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = waters_of_mother_rhoyne_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = tempestuous_winds_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = tempestuous_winds_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = men_at_arms_restoration_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = men_at_arms_restoration_spell_flag
			}
		}
		100 = {
			modifier = {
				zz_valyria_knows_spell  = {
					SPELL = rejuvenate_the_armies_spell_flag
				}
				add = -100
			}
			zz_add_spell  = {
				SPELL = rejuvenate_the_armies_spell_flag
			}
		}		
	}
}