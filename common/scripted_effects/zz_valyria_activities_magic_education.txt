zz_valyria_magic_education_skill_test = {
	add_character_flag = $ZZ_EVENT_OPTION_NAME$
	duel = {
		skill = $SKILL$
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 5
				min = -49
			}			
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success
				left_icon = root
				zz_valyria_magic_education_reward = yes
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success
				left_icon = root
				zz_valyria_magic_education_reward_medium = yes
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 2.5
				min = -49
			}
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success
				left_icon = root
				zz_valyria_magic_education_reward_minor = yes
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure
				left_icon = root
				zz_valyria_magic_education_reward_failure = yes

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}


zz_valyria_magic_education_reward = {
	if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.0100.a
		}	
		zz_valyria_magic_education_reward_skill_point_reward = { NUMBER = 5}
	}	
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.0100.b
		}	
		zz_valyria_magic_education_reward_massive = yes
	}	
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.0200.a
		}	
		zz_valyria_magic_education_reward_skill_point_reward = { NUMBER = 5}
	}	
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.0200.b
		}	
		zz_valyria_magic_education_reward_massive = yes
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.1100.a
		}	
		zz_valyria_magic_education_reward_massive = yes
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.1100.b
		}	
		zz_valyria_magic_education_reward_major = yes
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.1200.a
		}	
		zz_valyria_magic_education_reward_massive = yes
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.1200.b
		}	
		zz_valyria_magic_education_reward_major = yes
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.2100.a
		}	
		zz_valyria_magic_education_reward_random_spell_effect = yes
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.2100.b
		}	
		zz_valyria_magic_education_reward_skill_point_reward = { NUMBER = 3}
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.2100.y
		}	
		zz_valyria_magic_education_reward_massive = yes 
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.2200.a
		}	
		zz_valyria_magic_education_reward_random_spell_effect = yes
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.2200.b
		}	
		zz_valyria_magic_education_reward_skill_point_reward = { NUMBER = 3}
	}
	else_if = { 
		limit = { 
			has_character_flag = zz_valyria_magic_education.2200.y
		}	
		zz_valyria_magic_education_reward_massive = yes 
	}
}

zz_valyria_magic_education_reward_massive = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 40
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_massive
			scope:activity = { activity_special_type_progression_massive = yes }
		}
	}
}
zz_valyria_magic_education_reward_major = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 10
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_major
			scope:activity = { activity_special_type_progression_major = yes }
		}
	}
}
zz_valyria_magic_education_reward_medium = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 5
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_medium
			scope:activity = { activity_special_type_progression_medium = yes }
		}
	}
}
zz_valyria_magic_education_reward_minor = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 1
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_tiny	
			scope:activity = { activity_special_type_progression_tiny  = yes }
		}
	}
}
zz_valyria_magic_education_reward_failure = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = -5
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_failure	
			scope:activity = { activity_special_type_progression_negative  = yes }
		}
	}
}
zz_valyria_magic_education_reward_random_spell_effect = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 25
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_random_spell.tt
			scope:activity = { activity_special_type_progression_medium = yes }
			hidden_effect = {
				scope:host = { zz_random_gain_magic_spell = yes }
			}
		}
	}
}

zz_valyria_magic_education_reward_skill_point_reward = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 25
			tags = { good learning activity }
			character = root
			#Effect
			custom_tooltip =zz_valyria_magic_education_tt_positive_skill_increase.$NUMBER$.tt
			scope:activity = { activity_special_type_progression_major = yes }
			scope:host = {
				zz_magic_education_increase_skill_effect = {
					NUMBER = $NUMBER$
				}
			}		
		}
	}
}

zz_magic_education_increase_skill_effect = { 
	switch = {
		trigger = has_activity_intent
		study_valyrian_secrets = { 
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$ 
				XPTRACK = secrets_of_the_higher_mysteries
			}
		}
		study_blood_magic = { 
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$
				XPTRACK = blood_magic
			}
		}
		study_shadow_magic = {
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$
				XPTRACK = shadow_magic
			}
		}
		study_dream_magic = {
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$
				XPTRACK = dream_magic
			}
		}
		study_alchemy_magic = {
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$
				XPTRACK = alchemy_magic
			}
		}
		study_fire_magic ={
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$
				XPTRACK = fire_magic
			}
		}
		study_air_magic = {
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$
				XPTRACK = air_magic
			}
		}
		study_water_magic = {
			zz_valyria_gain_spell_experience = {
				XPGAIN = $NUMBER$
				XPTRACK = water_magic
			}
		}
	}
}


zz_valyria_magical_education_reward_massive = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 40
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_massive
			scope:activity = { activity_special_type_progression_massive = yes }
		}
	}
}
zz_valyria_magical_education_reward_major = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 10
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_major
			scope:activity = { activity_special_type_progression_major = yes }
		}
	}
}
zz_valyria_magical_education_reward_medium = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 5
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_medium
			scope:activity = { activity_special_type_progression_medium = yes }
		}
	}
}
zz_valyria_magical_education_reward_minor = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = 1
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_positive_tiny	
			scope:activity = { activity_special_type_progression_tiny  = yes }
		}
	}
}
zz_valyria_magical_education_reward_failure = {
	scope:activity = {
		add_activity_log_entry = {
			key = sic_et_non_log
			score = -5
			tags = { good learning activity }
			character = root

			#Effect
			custom_tooltip = zz_valyria_magic_education_tt_negative	
			scope:activity = { activity_special_type_progression_negative  = yes }
		}
	}
}

### Learn Spell Effect conclusion event 
zz_magic_education_learn_spell_effect = {
	zz_add_spell = { 
		SPELL = $SPELL$
	}
	scope:activity ?= {
		add_activity_log_entry = {
			key = learn.$SPELL$.t
			score = 25
			tags = { good learning activity }
			character = root
			#Effect
			custom_tooltip = learn.$SPELL$.t
		}
	}
}

zz_magic_education_determine_intent = { 
	if = { 
		limit = { 
			has_activity_intent = study_valyrian_secrets
		}
		add_character_flag = study_valyrian_secrets 
	}
	else_if = { 
		limit = { 
			has_activity_intent = study_blood_magic
		}
		add_character_flag = study_blood_magic 
	}
	else_if = { 
		limit = { 
			has_activity_intent = study_shadow_magic
		}
		add_character_flag = study_shadow_magic 
	}
	else_if = { 
		limit = { 
			has_activity_intent = study_dream_magic
		}
		add_character_flag = study_dream_magic 
	}
	else_if = { 
		limit = { 
			has_activity_intent = study_alchemy_magic
		}
		add_character_flag = study_alchemy_magic 
	}
	else_if = { 
		limit = { 
			has_activity_intent = study_fire_magic
		}
		add_character_flag = study_fire_magic 
	}
	else_if = { 
		limit = { 
			has_activity_intent = study_air_magic
		}
		add_character_flag = study_air_magic 
	}
	else_if = { 
		limit = { 
			has_activity_intent = study_water_magic
		}
		add_character_flag = study_water_magic 
	}
}
resolve_magic_education_success_reward_effect = {
	
	involved_activity ?= {
		#Perfect studies - 75-100
		if = {
			limit = { var:activity_special_type_progression >= 75 }
			scope:host = {
				add_character_flag = perfect_studies_reward
				add_character_flag = perfect_reward
			}
		}
		#High-end studies - 50-75
		else_if = {
			limit = { 
				var:activity_special_type_progression < 75
				var:activity_special_type_progression >= 50
			} 
			scope:host = {
				add_character_flag = high_studies_reward
				add_character_flag = high_reward
			}
		}
		#OK studies - 25-50
		else_if = {
			limit = {
				var:activity_special_type_progression < 50
				var:activity_special_type_progression >= 25
			}
			scope:host = {
				add_character_flag = mid_studies_reward
				add_character_flag = ok_reward
			}
		}
		#Lousy studies - 0-25
		else = {
			scope:host = {
				add_character_flag = low_studies_reward
			}
		}
	}
}



magic_education_completed_log_entry_effect = {
	
	involved_activity = {
		add_activity_log_entry = {
			key = magic_education_studies_completed_log
			tags = { completed }
			score = 100
			show_in_conclusion = yes
			character = root
			#Effects
			root = {
				disburse_magic_education_reward_effect = yes
			}
		}
	}
}



disburse_magic_education_reward_effect = {
	if = {
		limit = {
			has_character_flag = perfect_studies_reward
		}
		random = {
			chance = 25
			if = { 
				limit = { 
					has_trait = born_under_a_red_comet
				}
				add_trait_xp = { 
					trait = born_under_a_red_comet
					track = chosen_of_the_heavens
					value = 5
				}
			}
			else = { 
				add_trait_force_tooltip = born_under_a_red_comet
			}
			scope:activity = {
				add_to_variable_list = {
					name = trait_rewards
					target = trait:born_under_a_red_comet
				}
			}
		}
		remove_character_flag = perfect_studies_reward
	}
	else_if = {
		limit = {
			has_character_flag = high_studies_reward
		}
		remove_character_flag = high_studies_reward
	}
	else_if = {
		limit = {
			has_character_flag = mid_studies_reward
		}
		remove_character_flag = mid_studies_reward
	}
	else_if = {
		limit = {
			has_character_flag = low_studies_reward
		}
		remove_character_flag = low_studies_reward
	}
	# Options rewards
	if = {
		limit = {
			scope:activity = {
				has_activity_option = {
					category = adult_education_option_books
					option = adult_education_books_good
				}
			}
			has_dlc_feature = royal_court
			scope:host = { has_royal_court = yes }
		}
		custom_tooltip = adult_education_books_good_reward
		hidden_effect = {
			random_dummy_gender_effect = yes
			create_artifact_book_effect = {
				OWNER = scope:host
				CREATOR = scope:dummy_gender
				SET_SUBJECT = flag:no
				SET_TOPIC = flag:no
			}
			hidden_effect_new_object = {
				scope:newly_created_artifact = {
					set_artifact_rarity = illustrious
				}
				random_list = {
					50 = {
						scope:newly_created_artifact = {
							add_artifact_modifier = zz_valyria_magic_xp_gain_modifier_01_stacking
						}
					}
					50 = {
						scope:newly_created_artifact = {
							add_artifact_modifier = zz_valyria_magic_mana_gain_modifier_01_stacking
						}
					}
				}
			}
			scope:activity = {
				add_to_variable_list = {
					name = artifact_rewards
					target = scope:newly_created_artifact
				}
			}
			add_learning_skill = 1
		}
	}
	else_if = {
		limit = {
			scope:activity = {
				has_activity_option = {
					category = adult_education_option_books
					option = adult_education_books_good
				}
			}
		}
		custom_tooltip = adult_education_books_good_reward
		hidden_effect = {
			save_temporary_scope_value_as = {
				name = should_be_trinket
				value = yes
			}
			random_dummy_gender_effect = yes
			save_scope_value_as = {
				name = quality
				value = 50
			}
			save_scope_value_as = {
				name = wealth
				value = 50
			}
			create_artifact_book_effect = {
				OWNER = scope:host
				CREATOR = scope:dummy_gender
				SET_SUBJECT = flag:no
				SET_TOPIC = flag:no
			}
			hidden_effect_new_object = {
				scope:newly_created_artifact = {
					set_artifact_rarity = illustrious
				}
			}
			scope:activity = {
				add_to_variable_list = {
					name = artifact_rewards
					target = scope:newly_created_artifact
				}
			}
			add_learning_skill = 1
		}
	}
	else_if = {
		limit = {
			scope:activity = {
				has_activity_option = {
					category = adult_education_option_books
					option = adult_education_books_normal
				}
			}
		}
		add_learning_skill = 1
	}
}
