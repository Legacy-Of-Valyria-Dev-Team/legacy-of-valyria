

zz_valyria_heal_effect = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_healing
		desc = magic_healing_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_healing_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			scope:actor = {
				stress_impact = {
					compassionate = medium_stress_impact_loss
					sadistic = minor_stress_gain
					callous = minor_stress_gain
				}
			}
		}
		scope:recipient = {		
			if = { 
				limit = {
					scope:secondary_actor = { 
						has_trait = zz_magister
						has_trait_xp = {
							trait = zz_magister
							track = blood_magic 
							value >= 100
						}
					}
				}
				add_character_modifier = {
					modifier = zz_valyria_magic_life_span_boost_modifier 
					years = -1
				}
			}
			if = { 
				limit = {
					scope:secondary_actor = { 
						has_trait = zz_magister
						has_trait_xp = {
							trait = zz_magister
							track = blood_magic 
							value >= 75
						}
					}
				}
				add_character_modifier = {
					modifier = zz_valyria_magic_fertility_boost_modifier 
					years = -1
				}
			}
			if = { 
				limit = {
					scope:secondary_actor = { 
						has_trait = zz_magister
						has_trait_xp = {
							trait = zz_magister
							track = blood_magic 
							value >= 50
						}
					}
				}
				add_character_modifier = {
					modifier = zz_valyria_magic_disease_resistance_boost_modifier 
					years = 10
				}
			}
			if = { 
				limit = {
					scope:secondary_actor = { 
						has_trait = zz_magister
						has_trait_xp = {
							trait = zz_magister
							track = blood_magic 
							value >= 25
						}
					}
				}
				add_character_modifier = {
					modifier = zz_valyria_magic_health_boost_modifier 
					years = 10
				}
			}
			if = { limit = { has_trait = ill }
				remove_trait = ill
			}
			if = { limit = { has_trait = sickly }
				remove_trait = sickly
			}
			if = { limit = { has_trait = disfigured }
				remove_trait = disfigured
			}
			if = { limit = { has_trait = inbred }
				remove_trait = inbred
			}
			if = { limit = { has_trait = impotent }
				remove_trait = impotent
			}
			if = { limit = { has_trait = bleeder }
				remove_trait = bleeder
			}
			if = { limit = { has_trait = wheezing }
				remove_trait = wheezing
			}
			if = { limit = { has_trait = infertile }
				remove_trait = infertile
			}
			if = { limit = { has_trait = one_legged }
				remove_trait = one_legged
			}
			if = { limit = { has_trait = one_eyed }
				remove_trait = one_eyed
			}
			if = { limit = { has_trait = lunatic_genetic }
				remove_trait = lunatic_genetic
			}
			if = { limit = { has_trait = lunatic_1 }
				remove_trait = lunatic_1
			}
			if = { limit = { has_trait = pneumonic }
				remove_trait = pneumonic
			}
			if = { limit = { has_trait = great_pox }
				remove_trait = great_pox
			}
			if = { limit = { has_trait = early_great_pox }
				remove_trait = early_great_pox
			}
			if = { limit = { has_trait = lovers_pox }
				remove_trait = lovers_pox
			}
			if = { limit = { has_trait = leper }
				remove_trait = leper
			}
			if = { limit = { has_trait = wounded_1 }
				remove_trait = wounded_1
			}
			if = { limit = { has_trait = wounded_2 }
				remove_trait = wounded_2
			}
			if = { limit = { has_trait = wounded_3 }
				remove_trait = wounded_3
			}
			if = { limit = { has_trait = maimed }
				remove_trait = maimed
			}
			if = { limit = { has_trait = infirm }
				remove_trait = infirm
			}
			if = { limit = { has_trait = incapable }
				remove_trait = incapable
			}
			if = { limit = { has_trait = gout_ridden }
				remove_trait = gout_ridden
			}
			if = { limit = { has_trait = consumption }
				remove_trait = consumption
			}
			if = { limit = { has_trait = cancer }
				remove_trait = cancer
			}
			if = { limit = { has_trait = typhus }
				remove_trait = typhus
			}
			if = { limit = { has_trait = bubonic_plague }
				remove_trait = bubonic_plague
			}
			if = { limit = { has_trait = smallpox }
				remove_trait = smallpox
			}
			if = { limit = { has_trait = blind }
				remove_trait = blind
			}
			if = { limit = { has_character_modifier = chronic_headaches_modifier }
				remove_character_modifier = chronic_headaches_modifier
			}
			if = { limit = { has_character_modifier = infected_wound_modifier }
				remove_character_modifier = infected_wound_modifier
			}
			if = { limit = { has_character_modifier = gangrene_modifier }
				remove_character_modifier = gangrene_modifier
			}
			if = {	limit = {	has_trait = measles	}
				remove_trait = measles
			}
			if = {	limit = {	has_trait = dysentery	}
				remove_trait = dysentery
			}
			if = {	limit = {	has_trait = ergotism	}
				remove_trait = ergotism
			}
			if = {	limit = {	has_trait = scarred	}
				remove_trait = scarred
			}
			if = {
				limit = {
					NOT = { scope:actor = scope:recipient }
				}
				add_opinion = {
					modifier = grateful_opinion
					target = scope:actor
					opinion = 70
				}
			}
		}
	}	
}

zz_valyria_genetic_manipulation = {
	send_interface_message = {
		type = event_generic_neutral
		title = magic_genetic_manipulation
		desc = magic_genetic_manipulation_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_genetic_manipulation_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			stress_impact = {
				compassionate = medium_stress_impact_loss
				sadistic = minor_stress_gain
				callous = minor_stress_gain
			}
		}
		scope:recipient = {
			if = {
				limit = {
					scope:add_trait_intellect_good_3 = yes
				}
				scope:recipient = { 
					if = {
						limit = { 
							has_trait = intellect_bad 
							NOT = { 
								has_trait = intellect_bad_1
							}
						}
						change_trait_rank = {
							trait = intellect_bad
							rank = -1
						}
					}
					else = {
						if = {
							limit = {
								NOT = {
									has_trait = intellect_good
								}
							}
							add_trait_force_tooltip = intellect_good_1
						}
						else = {
							change_trait_rank = {
								trait = intellect_good
								rank = 1
							}
						}
					}
				} 
			}			
			else_if = {
				limit = {
					scope:add_trait_physique_good_3 = yes
				}
				scope:recipient = { 
					if = {
						limit = { 
							has_trait = physique_bad 
							NOT = { 
								has_trait = physique_bad_1
							}
						}
						change_trait_rank = {
							trait = physique_bad
							rank = -1
						}
					}
					else = {
						if = {
							limit = {
								NOT = {
									has_trait = physique_good
								}
							}
							add_trait_force_tooltip = physique_good_1
						}
						else = {
							change_trait_rank = {
								trait = physique_good
								rank = 1
							}
						}
					}
				}
			}			
			else_if = {
				limit = {
					scope:add_trait_beauty_good_3 = yes
				}
				scope:recipient = { 
					if = {
						limit = { 
							has_trait = beauty_bad 
							NOT = { 
								has_trait = beauty_bad_1
							}
						}
						change_trait_rank = {
							trait = beauty_bad
							rank = -1
						}
					}
					else = {
						if = {
							limit = {
								NOT = {
									has_trait = beauty_good
								}
							}
							add_trait_force_tooltip = beauty_good_1
						}
						else = {
							change_trait_rank = {
								trait = beauty_good
								rank = 1
							}
						}
					}
				}
			}			
			else_if = {
				limit = {
					scope:remove_trait_infertile = yes
				}
				scope:recipient = { 
					remove_trait = infertile
				} 		
			}		
			if = {
				limit = {
					NOT = { scope:actor = scope:recipient }
				}
				add_opinion = {
					modifier = grateful_opinion
					target = scope:actor
					opinion = 70
					}
				}
		}
	}
}

zz_valyria_restore_maa = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_restore_maa
		desc = magic_restore_maa_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_restore_maa_text
		scope:target = {
			change_maa_troops_count = 100 
		}
	}
}
zz_valyria_renew_armies = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_renew_armies
		desc = magic_renew_armies_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_renew_armies_text
		scope:recipient = {
			commanding_army = { 
				deplete_army_by_percentage = -0.5
			}
		}
	}
}

# Dream Magic 
zz_valyria_mental_domination = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_domination
		desc = magic_domination_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_domination_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			stress_impact = {
				compassionate = medium_stress_impact_loss
				sadistic = minor_stress_gain
				callous = minor_stress_gain
			}
		}
		scope:recipient = {
			every_relation = {
				type = magic_master
				remove_relation_magic_minion = scope:recipient
			}
		}
		set_relation_magic_minion = scope:recipient
		hidden_effect = {
			if = {
				limit = {
					has_hook = scope:recipient
				}
				remove_hook = {
					target = scope:recipient
				}
			}
			scope:recipient = {
				if = {
					limit = {
						has_hook = scope:actor
					}
					remove_hook = {
						target = scope:actor
					}
				}
			}
		}
		add_hook = {
				type = magic_domination_hook
				target = scope:recipient
		}
		if = {
			limit = {
				scope:magic_domination_faith = yes
			}
			scope:recipient = {
				custom_tooltip = mind_control_custom_tooltip
				set_culture_same_as = scope:actor
				set_character_faith = scope:actor.faith
			}
		}
		else = {
			scope:recipient = {
				custom_tooltip = mind_control_custom_tooltip
			}
		}
	}
}

zz_valyria_dreaming_within = {
	send_interface_message = {
		type = event_generic_neutral
		title = magic_dreaming_within
		desc = magic_dreaming_within_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_dreaming_within_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			stress_impact = {
				compassionate = medium_stress_impact_loss
				sadistic = minor_stress_gain
				callous = minor_stress_gain
			}
		}
		scope:recipient = {
			if  = { 
				limit = {
					scope:blademaster_magic = yes
				}
				scope:recipient = {
					if = {
						limit = { has_trait = lifestyle_blademaster }
						add_trait_xp = {
							trait = lifestyle_blademaster
							value = 30
						}
					}
					else = { add_trait = lifestyle_blademaster }
				}
			}	
			else_if  = { 
				limit = {
					scope:mystic_magic = yes
				}
				scope:recipient = {
					if = {
						limit = { has_trait = lifestyle_mystic }
						add_trait_xp = {
							trait = lifestyle_mystic
							value = 30
						}
					}
					else = { add_trait = lifestyle_mystic }
				}
			}
			else_if  = { 
				limit = {
					scope:reveler_magic = yes
				}
				scope:recipient = {
					if = {
						limit = { has_trait = lifestyle_reveler }
						add_trait_xp = {
							trait = lifestyle_reveler
							value = 30
						}
					}
					else = { add_trait = lifestyle_reveler }
				}
			}	
			else_if  = { 
				limit = {
					scope:hunter_magic = yes
				}
				scope:recipient = {
					if = {
						limit = { has_trait = lifestyle_hunter }
						add_trait_xp = {
							trait = lifestyle_hunter
							value = 30
						}
					}
					else = { add_trait = lifestyle_hunter }
				}
			}	
			else_if  = { 
				limit = {
					scope:physician_magic = yes
				}
				scope:recipient = {
					if = {
						limit = { has_trait = lifestyle_physician }
						add_trait_xp = {
							trait = lifestyle_physician
							value = 30
						}
					}
					else = { add_trait = lifestyle_physician }
				}
			}	
			else_if  = { 
				limit = {
					scope:herbalist_magic = yes
				}
				scope:recipient = {
					if = {
						limit = { has_trait = lifestyle_herbalist }
						add_trait_xp = {
							trait = lifestyle_herbalist
							value = 30
						}
					}
					else = { add_trait = lifestyle_herbalist }
				}
			}		
			else_if  = { 
				limit = {
					scope:gardener_magic = yes
				}
				scope:recipient = {
					if = {
						limit = { has_trait = lifestyle_gardener }
						add_trait_xp = {
							trait = lifestyle_gardener
							value = 30
						}
					}
					else = { add_trait = lifestyle_gardener }
				}
			}				
			if = {
				limit = {
					NOT = { scope:actor = scope:recipient }
				}
				add_opinion = {
					modifier = grateful_opinion
					target = scope:actor
					opinion = 70
				}
			}
		}
	}
}

zz_valyria_dreams_of_experience = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_dreams_of_experience 
		desc = magic_dreams_of_experience_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_dreams_of_experience_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			stress_impact = {
				compassionate = medium_stress_impact_loss
				sadistic = minor_stress_gain
				callous = minor_stress_gain
			}
		}
		scope:recipient = {
			if = {
				limit = {
					scope:experience_learning = yes
				}
				scope:recipient = { add_learning_lifestyle_xp = 500 } 
			}
			else_if = {
				limit = {
					scope:experience_diplomacy = yes
				}
				scope:recipient = { add_diplomacy_lifestyle_xp = 500 } 
			}
			else_if = {
				limit = {
					scope:experience_stewardship = yes
				}
				scope:recipient = { add_stewardship_lifestyle_xp = 500 } 
			}
			else_if = {
				limit = {
					scope:experience_intrigue = yes
				}
				scope:recipient = { add_intrigue_lifestyle_xp = 500 } 
			}
			else_if = {
				limit = {
					scope:experience_martial = yes
				}
				scope:recipient = { add_martial_lifestyle_xp = 500 } 
			}
			else_if = {
				limit = {
					scope:experience_prowess = yes
				}
				scope:recipient = { add_nht_prowess_lifestyle_xp = 500 } 
			}
			else_if = {
				limit = {
					scope:experience_leadership = yes
				}
				scope:recipient = { add_nht_leadership_lifestyle_xp = 500 } 
			}
			
			if = {
				limit = {
					NOT = { scope:actor = scope:recipient }
				}
				add_opinion = {
					modifier = grateful_opinion
					target = scope:actor
					opinion = 70
					}
				}
		}
	}
}

zz_valyria_secrets_of_dreams = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_secrets_of_dreams
		desc = magic_secrets_of_dreams_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_secrets_of_dreams_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			stress_impact = {
				compassionate = medium_stress_impact_loss
				sadistic = minor_stress_gain
				callous = minor_stress_gain
			}
		}
		scope:recipient = {
			if = {
				limit = {
					scope:scrying = yes
				}
				scope:recipient = { 
					zz_dragon_dreams = yes
					random_list = {
						21 = {
							trigger_event = zz_valyria_magic_scrying.1
						}
						9 = {
							trigger_event = zz_valyria_magic_scrying.2
						}
					}
				} 
			}			
			if = {
				limit = {
					NOT = { scope:actor = scope:recipient }
				}
				add_opinion = {
					modifier = grateful_opinion
					target = scope:actor
					opinion = 70
				}
			}
		}
	}
}


# Alchemical Magic
zz_valyria_development_boost = {  
	send_interface_message = {
		type = event_generic_neutral
		title = magic_development_boost
		desc = magic_development_boost_text
		left_icon = scope:actor
		right_icon = scope:target.title_province 
		custom_tooltip = magic_development_boost_text
		scope:target.title_province = {
			county = {
				if = {
					limit = {
						scope:secondary_actor  = {
							any_character_artifact = {
								has_variable = glass_candle
							}
						}
					}
					add_county_modifier = {
						modifier = zz_valyria_magic_province_buff_spell_development_modifier
						years = 20
					}
				}
				else = {
					add_county_modifier = {
						modifier = zz_valyria_magic_province_buff_spell_development_modifier
						years = 10
					}
				}
			}
		}
	}
}

zz_valyria_build_speed_boost = {  
	send_interface_message = {
		type = event_generic_neutral
		title = magic_build_speed_boost
		desc = magic_build_speed_boost_text
		left_icon = scope:actor
		right_icon = scope:target.title_province 
		custom_tooltip = magic_build_speed_boost_text
		scope:target.title_province = {
			county = {
				if = {
					limit = {
						scope:secondary_actor = {
							any_character_artifact = {
								has_variable = glass_candle
							}
						}
					}
					add_county_modifier = {
						modifier = zz_valyria_magic_province_buff_spell_build_speed_modifier
						years = 20
					}
				}
				else = {
					add_county_modifier = {
						modifier = zz_valyria_magic_province_buff_spell_build_speed_modifier
						years = 10
					}
				}
				
			}
		}
	}
}

zz_valyria_transmutation = {
	send_interface_message = {
		type = event_generic_neutral
		title = magic_transmutation
		desc = magic_transmutation_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_transmutation_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			stress_impact = {
				compassionate = medium_stress_impact_loss
				sadistic = minor_stress_gain
				callous = minor_stress_gain
			}
		}
		scope:recipient = {
			if = {
				limit = {
					scope:dynasty_prestige = yes
				}
				scope:recipient = { 
					dynasty = { add_dynasty_prestige = zz_valyria_magic_potency_secret_knowledge}
					
				}
			}
			else_if = {
				limit = {
					scope:prestige= yes
				}
				scope:recipient = { add_prestige = zz_valyria_magic_potency_secret_knowledge } 
			}
			else_if = {
				limit = {
					scope:piety= yes
				}
				scope:recipient = { add_piety = zz_valyria_magic_potency_secret_knowledge } 
			}
			else_if = {
				limit = {
					scope:transmutation = yes
				}
				scope:recipient = { add_gold = zz_valyria_magic_potency_secret_knowledge } 
			}				
			if = {
				limit = {
					NOT = { scope:actor = scope:recipient }
				}
				add_opinion = {
					modifier  = grateful_opinion
					target = scope:actor
					opinion = 70
				}
			}
		}
	}
}

zz_valyria_empowerment_of_arms = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_empowerment_of_arm
		desc = magic_empowerment_of_arm_text
		left_icon = scope:actor
		right_icon = scope:recipient
		custom_tooltip = magic_empowerment_of_arm_text
		if = {
			limit = {
				NOT = {
					scope:actor = scope:recipient
				}
			}
			stress_impact = {
				compassionate = medium_stress_impact_loss
				sadistic = minor_stress_gain
				callous = minor_stress_gain
			}
		}
		scope:recipient = {			
			if = {
				limit = {
					scope:knights_add = yes
				}
				scope:recipient = { add_character_modifier = { modifier = zz_valyria_magic_character_knight_limit_modifier years = -1 }} 
			}
			else_if = {
				limit = {
					scope:knights_bonus = yes
				}
				scope:recipient = { add_character_modifier = { modifier = zz_valyria_magic_character_knight_effectiveness_modifier years = -1 } } 
			}
			else_if = {
				limit = {
					scope:maa_bonus = yes
				}
				scope:recipient = { add_character_modifier = { modifier = zz_valyria_magic_character_maa_limit_modifier years = -1 } } 
			}
			else_if = {
				limit = {
					scope:maa_size_bonus = yes
				}
				scope:recipient = { add_character_modifier = { modifier = zz_valyria_magic_character_maa_size_modifier years = -1 } } 
			}
			else_if = {
				limit = {
					scope:title_maa_bonus = yes
				}
				scope:recipient = { add_character_modifier = { modifier = zz_valyria_magic_character_title_maa_limit_modifier years = -1 } } 
			}
			else_if = {
				limit = {
					scope:title_maa_size_bonus = yes
				}
				scope:recipient = { add_character_modifier = { modifier = zz_valyria_magic_character_title_maa_size_modifier years = -1 } } 
			}
			
			
			if = {
				limit = {
					NOT = { scope:actor = scope:recipient }
				}
				add_opinion = {
					modifier = grateful_opinion
					target = scope:actor
					opinion = 70
				}
			}
		}
	}
}

# Fire Magic 

zz_valyria_flame_strike = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_flame_strike
		desc = magic_flame_strike_text
		left_icon = scope:actor
		right_icon = scope:recipient					
		custom_tooltip = magic_flame_strike_text

		if = {
			limit = {
				has_trait = compassionate
				has_trait = wrathful
				has_trait = sadistic
			}
			stress_impact = {
				compassionate = medium_stress_impact_gain
				wrathful = medium_stress_impact_loss
				sadistic = medium_stress_impact_loss
			}
		}
		else_if = {
			limit = {
				OR = {
					has_relation_rival = scope:recipient
					has_relation_nemesis = scope:recipient
				}
			}
			add_stress = major_stress_loss
			stress_impact = {
				forgiving = medium_stress_impact_gain
				wrathful = medium_stress_impact_loss
				sadistic = medium_stress_impact_loss
			}
		}
		if = {
			limit = {
				scope:weaken_spell_flag = yes
			}
			add_dread = medium_dread_gain
			scope:recipient = {
				if = {
					limit = {
						scope:power_strike_imprison_flag = yes
					}
					add_trait = wounded_3
					add_trait = burned
					add_trait_xp = {
						trait = burned
						value = { 5 200 }
					}
					add_stress = massive_stress_gain
					imprison_character_effect = {
						TARGET = scope:recipient
						IMPRISONER = scope:actor
					}
				}
				else = {
					show_as_tooltip = {
						add_trait = wounded_3
						add_stress = massive_stress_gain
					}
					scope:actor = {
						if = {
							limit = {
								NOR = {
									has_imprisonment_reason = scope:recipient
									has_banish_reason = scope:recipient
									has_execute_reason = scope:recipient
								}
							}
							add_tyranny = minor_tyranny_gain
						}
					}
					custom_tooltip = power_strike_spare_ct
				}
			}
		}
		else = {
			add_dread = major_dread_gain
			if = {
				limit = {
					scope:secondary_actor = {
						is_in_army = yes
						exists = commanding_army
						commanding_army = {
							is_army_in_combat = yes
						}
					}
					scope:recipient = {
						is_in_army = yes
						OR = {
							AND = {
								exists = commanding_army
								commanding_army = {
									is_army_in_combat = yes
								}
								NOT = {
									commanding_army = scope:secondary_actor.commanding_army
								}
								commanding_army.location = scope:secondary_actor.commanding_army.location
							}
							AND = {
								exists = liege_or_court_owner
								liege_or_court_owner = {
									any_army = {
										is_army_in_combat = yes
										NOT = {
											THIS = scope:secondary_actor.commanding_army
										}
										location = scope:secondary_actor.commanding_army.location
									}
								}
							}
						}
					}
				}
				scope:secondary_actor = {
					add_character_flag = mage_during_battle_flag
				}
			}
			else = {
				if = {
					limit = {
						has_execute_reason = scope:recipient
					}
					custom_tooltip = IS_ALLOWED_TO_EXECUTE_DESC
				}
				else = {
					add_tyranny = execution_tyranny_gain
					add_kinslayer_trait_or_nothing_effect = { VICTIM = scope:recipient }
					if = {
						limit = {
							NOT = {	has_trait = murderer	}
						}
						add_trait = murderer
					}
					hidden_effect = {
						if = {
							limit = {
								exists = scope:recipient.primary_heir
								scope:recipient.primary_heir = {
									any_close_family_member = {
										this = scope:recipient
									}
									NOR = {
										has_relation_rival = scope:actor
										has_relation_nemesis = scope:actor
										has_relation_magic_minion  = scope:actor
										has_trait = craven
										has_trait = forgiving
									}
								}
							}
							set_relation_rival = scope:recipient.primary_heir
						}
						else_if = {
							limit = {
								scope:recipient.age<16
								exists = scope:recipient.father
								scope:recipient.father = {
									is_alive = yes
									is_landed = yes
									is_ruler = yes
									NOR = {
										has_relation_rival = scope:actor
										has_relation_nemesis = scope:actor
										has_relation_magic_minion = scope:actor
										has_trait = craven
										has_trait = forgiving
									}
								}
							}
							set_relation_rival = scope:recipient.father
						}
					}
				}
			}
		}				
		hidden_effect = {
			if = {
				limit = {
					trait_is_criminal_in_faith_trigger = { TRAIT = witch FAITH = scope:secondary_actor.faith GENDER_CHARACTER = scope:secondary_actor }
				}
				every_ruler = {
					limit = {
						faith = scope:secondary_actor.faith
						NOR = {
							this = scope:secondary_actor
							has_trait = witch
							has_trait = cynical
							has_trait = forgiving
							any_secret = { secret_type = secret_witch }
						}
					}
						#use_magic_opinion
					if = {
						limit = {
							NOR = {
								has_trait = zealous
								has_trait = theologian
							}
						}
						add_opinion = {
							modifier = use_magic_opinion
							target = scope:secondary_actor
							opinion = -30
						}
					}
					else = {
						add_opinion = {
							modifier = use_magic_opinion
							target = scope:secondary_actor
							opinion = -50
						}
					}
				}
				scope:secondary_actor = {
					every_courtier_or_guest = {
						limit = {
							faith = scope:secondary_actor.faith
							NOR = {
								this = scope:secondary_actor
								has_trait = witch
								has_trait = cynical
								has_trait = forgiving
								any_secret = { secret_type = secret_witch }
							}
						}
						add_opinion = {
							modifier = use_magic_opinion
							target = scope:secondary_actor
							opinion = -30
						}
					}
				}
				if = {
					limit = {
						exists = scope:secondary_actor.faith.religious_head
						NOT = {	scope:secondary_actor.faith.religious_head = scope:secondary_actor	}
						NOT = {	has_trait = excommunicated	}
						NOT = {	has_character_modifier = excommunication_recently_lifted	}
						scope:secondary_actor.faith = {
							has_doctrine = tenet_communion
							has_doctrine = doctrine_spiritual_head
						}
						scope:secondary_actor.faith.religious_head = {
							opinion = { target = scope:secondary_actor value < 0 }
						}
					}
					add_trait = excommunicated
				}
			}
		}
		if = {
			limit = {
				scope:weaken_spell_flag = no
			}
			if = {
				limit = {
					scope:secondary_actor = {
						has_character_flag = mage_during_battle_flag
					}
				}
				scope:recipient = {
					add_trait_xp = {
						trait = burned
						value = { 5 200 }
					}
					death = {
						death_reason = death_battle
						killer = scope:secondary_actor
					}
				}
				scope:secondary_actor = {
					remove_character_flag = mage_during_battle_flag
				}
			}
			else = {
				execute_opinion_effect = { VICTIM = scope:recipient EXECUTIONER = scope:secondary_actor }
				scope:recipient = {
					add_trait_xp = {
						trait = burned
						value = { 5 200 }
					}
					death = {
						death_reason = death_execution
						killer = scope:secondary_actor
					}
				}
			}
		}		
	}
}

valyria_fire_blast = { 
	send_interface_message = {
		type = event_generic_neutral
		title = magic_flame_blast
		desc = magic_flame_blast_text
		left_icon = scope:actor
		right_icon = scope:recipient					
		custom_tooltip = magic_flame_blast_text
		scope:recipient = {
			location = {
				every_army_in_location = {
					limit = { 
						army_owner = scope:recipient
					}
					deplete_army_by_percentage = 0.3
				}
			}
			commanding_army = { 
				deplete_army_by_percentage = 0.9
			}
		}
	}
}