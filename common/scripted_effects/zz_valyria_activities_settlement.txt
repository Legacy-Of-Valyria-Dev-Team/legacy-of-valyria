zz_valyria_settlement_random_test = {
	random_list = {
		25 = {
			desc = $ZZ_EVENT_OPTION_NAME$.crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_colonisation_tt_positive_major
				scope:activity = {
					add_activity_log_entry = {
						key = sic_et_non_log
						score = 25
						tags = { good learning activity }
						character = root
		
						#Effect
						custom_tooltip = zz_valyria_colonisation_tt_positive_major
						scope:activity = { activity_special_type_progression_major  = yes }
					}
				}
				
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		25 = {
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_colonisation_tt_positive_medium
				scope:activity = {
					add_activity_log_entry = {
						key = sic_et_non_log
						score = 25
						tags = { good learning activity }
						character = root
		
						#Effect
						custom_tooltip = zz_valyria_colonisation_tt_positive_medium
						scope:activity = { activity_special_type_progression_medium  = yes }
					}
				}
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		25 = {
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_colonisation_tt_positive_tiny
				scope:activity = {
					add_activity_log_entry = {
						key = sic_et_non_log
						score = 25
						tags = { good learning activity }
						character = root
		
						#Effect
						custom_tooltip = zz_valyria_colonisation_tt_positive_tiny
						scope:activity = { activity_special_type_progression_tiny  = yes }
					}
				}
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		25 = {
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = 
				scope:activity = {
					add_activity_log_entry = {
						key = sic_et_non_log
						score = 25
						tags = { good learning activity }
						character = root
		
						#Effect
						custom_tooltip = zz_valyria_colonisation_tt_negative
						scope:activity = { activity_special_type_progression_negative  = yes }
					}
				}
			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
}
zz_valyria_settlement_learning_test = {
	duel = {
		skill = learning
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}			
			desc = $ZZ_EVENT_OPTION_NAME$.crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				
				custom_tooltip = $ZZ_EVENT_OPTION_NAME$.tt
				
				zz_valyria_settlement_reward = yes
				
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_medium
				scope:activity = { activity_special_type_progression_medium  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_tiny
				scope:activity = { activity_special_type_progression_tiny  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_negative
				scope:activity = { activity_special_type_progression_negative = yes }

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}
zz_valyria_settlement_diplomacy_test = {
	duel = {
		skill = diplomacy
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}			
			desc = $ZZ_EVENT_OPTION_NAME$..crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				
				custom_tooltip = $ZZ_EVENT_OPTION_NAME$.tt
				
				zz_valyria_settlement_reward = yes
				
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_medium
				scope:activity = { activity_special_type_progression_medium  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_tiny
				scope:activity = { activity_special_type_progression_tiny  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_negative
				scope:activity = { activity_special_type_progression_negative = yes }

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}
zz_valyria_settlement_stewardship_test = {
	duel = {
		skill = stewardship
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}			
			desc = $ZZ_EVENT_OPTION_NAME$..crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				
				custom_tooltip = $ZZ_EVENT_OPTION_NAME$.tt
				
				zz_valyria_settlement_reward = yes
				
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_medium
				scope:activity = { activity_special_type_progression_medium  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_tiny
				scope:activity = { activity_special_type_progression_tiny  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_negative
				scope:activity = { activity_special_type_progression_negative = yes }

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}
zz_valyria_settlement_intrigue_test = {
	duel = {
		skill = intrigue
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}			
			desc = $ZZ_EVENT_OPTION_NAME$..crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				
				custom_tooltip = $ZZ_EVENT_OPTION_NAME$.tt
				
				zz_valyria_settlement_reward = yes
				
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_medium
				scope:activity = { activity_special_type_progression_medium  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_tiny
				scope:activity = { activity_special_type_progression_tiny  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_negative
				scope:activity = { activity_special_type_progression_negative = yes }

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}
zz_valyria_settlement_martial_test = {
	duel = {
		skill = stewardship
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}			
			desc = $ZZ_EVENT_OPTION_NAME$..crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				
				custom_tooltip = $ZZ_EVENT_OPTION_NAME$.tt
				
				zz_valyria_settlement_reward = yes
				
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_medium
				scope:activity = { activity_special_type_progression_medium  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_tiny
				scope:activity = { activity_special_type_progression_tiny  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_negative
				scope:activity = { activity_special_type_progression_negative = yes }

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}
zz_valyria_settlement_martial_test = {
	duel = {
		skill = martial
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}			
			desc = $ZZ_EVENT_OPTION_NAME$..crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				
				custom_tooltip = $ZZ_EVENT_OPTION_NAME$.tt
				
				zz_valyria_settlement_reward = yes
				
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_medium
				scope:activity = { activity_special_type_progression_medium  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_tiny
				scope:activity = { activity_special_type_progression_tiny  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_negative
				scope:activity = { activity_special_type_progression_negative = yes }

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}

zz_valyria_settlement_prowess_test = {
	duel = {
		skill = prowess
		value = high_skill_rating
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}			
			desc = $ZZ_EVENT_OPTION_NAME$..crit_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.crit_success.tt
				left_icon = root
				
				custom_tooltip = $ZZ_EVENT_OPTION_NAME$.tt
				
				zz_valyria_settlement_reward = yes
				
			}
			stress_impact = {
				base = medium_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_medium
				scope:activity = { activity_special_type_progression_medium  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		20 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = 3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.small_success
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.small_success.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_positive_tiny
				scope:activity = { activity_special_type_progression_tiny  = yes }
			}
			stress_impact = {
				base = minor_stress_impact_loss
			}
		}
		40 = {
			compare_modifier = {
				value = scope:duel_value
				multiplier = -3.5
				min = -49
			}
			desc = $ZZ_EVENT_OPTION_NAME$.failure
			send_interface_toast = {
				title = $ZZ_EVENT_OPTION_NAME$.failure.tt
				left_icon = root
				custom_tooltip = zz_valyria_settlement_tt_negative
				scope:activity = { activity_special_type_progression_negative = yes }

			}
			stress_impact = {
				base = medium_stress_impact_gain
			}
		}
	}
	remove_character_flag = $ZZ_EVENT_OPTION_NAME$
}

zz_valyria_settlement_reward = {
	switch = {
		trigger = has_character_flag
		zz_valyria_settlement.0100.a = {

			scope:activity = {
				add_activity_log_entry = {
					key = sic_et_non_log
					score = 25
					tags = { good learning activity }
					character = root
	
					#Effect
					custom_tooltip = zz_valyria_settlement_tt_positive_major
					scope:activity = { activity_special_type_progression_major = yes }
				}
			}
		}
	}
}

resolve_valyria_settlement_success_reward_effect = {
	scope:host = { 
		if = { 
			limit = { 
				has_activity_intent = settle_castle 
			}
			add_character_flag = settle_castle
		}
		if = { 
			limit = { 
				has_activity_intent = settle_city 
			}
			add_character_flag = settle_city
		}
		if = { 
			limit = { 
				has_activity_intent = settle_temple 
			}
			add_character_flag = settle_temple
		}
	}
	
	involved_activity ?= {
		
		#Perfect settlement - 75-100
		if = {
			limit = { var:activity_special_type_progression >= 75 }
			scope:host = {
				add_character_flag = perfect_settlement_reward
			}
		}
		#High-end settlement - 50-75
		else_if = {
			limit = { 
				var:activity_special_type_progression < 75
				var:activity_special_type_progression >= 50
			} 
			scope:host = {
				add_character_flag = high_settlement_reward
			}
		}
		#OK settlement - 25-50
		else_if = {
			limit = {
				var:activity_special_type_progression < 50
				var:activity_special_type_progression >= 25
			}
			scope:host = {
				add_character_flag = mid_settlement_reward
			}
		}
		#Lousy settlement - 0-25
		else = {
			scope:host = {
				add_character_flag = low_settlement_reward
			}
		}
	}
}



valyria_settlement_completed_log_entry_effect = {
	involved_activity = {
		add_activity_log_entry = {
			key = valyria_settlement_completed_log
			tags = { completed }
			score = 100
			show_in_conclusion = yes
			character = root
			#Effects
			root = {
				disburse_valyria_settlement_reward_effect = yes
			}
		}
	}
}
disburse_valyria_settlement_reward_effect = {
	switch = { # Hand out lifestyle perks/xp
		trigger = has_character_flag
		perfect_settlement_reward = { 
			zz_valyria_settlement_effect = yes
		}
		high_settlement_reward = { 
			zz_valyria_settlement_effect = yes
		}
		mid_settlement_reward = { 
			zz_valyria_settlement_effect = yes			
		}
		low_settlement_reward = { 
			remove_character_flag = low_settlement_reward
		}
	}
}



zz_valyria_settlement_effect = { 
	scope:host = { 
		scope:province = { barony = { set_coa = this.holder.house }} 
		switch = {
			trigger = has_character_flag 
			settle_castle = { 
				scope:province = {
					set_holding_type = castle_holding	
				}
				switch = {
					trigger = has_character_flag
					perfect_settlement_reward = {
						scope:province = {
							add_building = castle_03
						}
						remove_character_flag = perfect_settlement_reward
					}
					high_settlement_reward = {
						scope:province = {
							add_building = castle_02
						}
						remove_character_flag = high_settlement_reward
					}
					mid_settlement_reward ={
						scope:province = {
							add_building = castle_01
						}
						remove_character_flag = mid_settlement_reward
					}
				}
				
				remove_character_flag = settle_castle
			}
			settle_city = { 
				scope:province  = {
					set_holding_type = city_holding
					
				}
				switch = {
					trigger = has_character_flag
					perfect_settlement_reward = {
						scope:province = {
							add_building = city_03
						}
						remove_character_flag = perfect_settlement_reward
					}
					high_settlement_reward = {
						scope:province = {
							add_building = city_02
						}
						remove_character_flag = high_settlement_reward
					}
					mid_settlement_reward ={
						scope:province = {
							add_building = city_01
						}
						remove_character_flag = mid_settlement_reward
					}
				}
				remove_character_flag = settle_city
			}
			settle_temple = { 
				scope:province = {
					set_holding_type = church_holding
				}
				switch = {
					trigger = has_character_flag
					perfect_settlement_reward = {
						scope:province = {
							add_building = temple_03
						}
						remove_character_flag = perfect_settlement_reward
					}
					high_settlement_reward = {
						scope:province = {
							add_building = temple_02
						}
						remove_character_flag = high_settlement_reward
					}
					mid_settlement_reward ={
						scope:province = {
							add_building = temple_01
						}
						remove_character_flag = mid_settlement_reward
					}
				}
				remove_character_flag = settle_temple
			}
		}
		if = {
			limit = { has_character_flag = large_settlement_development_gain }
			 scope:province = {
				 county = {
					 change_development_level = 10
				 }
			 }
		 }
		 else_if = {
			 limit = { has_character_flag = med_settlement_development_gain }
			 scope:province = {
				 county = {
					 change_development_level = 6
				 }
			 }
		 }
	}
}


zz_valyria_settlment_construct_secondary_buildings = {
	if = { 
		limit = {
			has_character_flag = learning_building_flag
		}
		remove_character_flag = learning_building_flag
	}
	if = { 
		limit = {
			has_character_flag = diplomacy_building_flag
		}
		remove_character_flag = diplomacy_building_flag
	}
	if = { 
		limit = {
			has_character_flag = stewardship_building_flag
		}
		remove_character_flag = stewardship_building_flag
	}
	if = { 
		limit = {
			has_character_flag = intrigue_building_flag
		}
		remove_character_flag = intrigue_building_flag
	}
	if = { 
		limit = {
			has_character_flag = martial_building_flag
		}
		remove_character_flag = martial_building_flag
	}
	if = { 
		limit = {
			has_character_flag = prowess_building_flag
		}
		remove_character_flag = prowess_building_flag
	}
}

